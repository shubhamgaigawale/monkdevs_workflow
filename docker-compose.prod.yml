# Docker Compose Override for Production Environment
version: '3.8'

services:
  postgres:
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-crm_production_db}
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G
    restart: always
    # Production backup volume
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/postgres:/backups

  redis:
    ports:
      - "${REDIS_PORT:-6381}:6379"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-secure_redis_password}

  # Production configuration for services
  api-gateway:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD_GATEWAY=WARN
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  user-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  hr-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  lead-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  call-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  campaign-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  integration-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  notification-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  billing-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  reporting-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  customer-admin-service:
    environment:
      - LOGGING_LEVEL_ROOT=WARN
      - SPRING_JPA_SHOW_SQL=false
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    environment:
      - VITE_API_URL=${VITE_API_URL}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Disable PgAdmin in production by default (use profiles to enable if needed)
  pgadmin:
    profiles:
      - tools

volumes:
  postgres_data:
  redis_data:
